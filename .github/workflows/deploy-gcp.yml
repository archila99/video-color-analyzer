# Deploy to Google Cloud on push to main
# Requires GitHub secrets: GCP_PROJECT_ID, GCP_SA_KEY, FIREBASE_PROJECT_ID, FIREBASE_TOKEN

name: Deploy to GCP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker gcr.io --quiet

      - name: Deploy backend to Cloud Run
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          gcloud builds submit --tag gcr.io/$PROJECT_ID/video-image-api
          gcloud run deploy video-image-api \
            --project $PROJECT_ID \
            --image gcr.io/$PROJECT_ID/video-image-api \
            --platform managed \
            --region europe-west1 \
            --allow-unauthenticated \
            --set-env-vars "CORS_ORIGINS=*" \
            --memory 2Gi \
            --cpu 2 \
            --timeout 300 \
            --cpu-boost \
            --quiet

      - name: Get backend URL
        id: backend
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          URL=$(gcloud run services describe video-image-api --project $PROJECT_ID --region europe-west1 --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          VITE_API_URL=${{ steps.backend.outputs.url }} npm run build

      - name: Deploy frontend to Firebase
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only hosting --project ${{ secrets.FIREBASE_PROJECT_ID }} --non-interactive
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

      - name: Update backend CORS
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        run: |
          CORS_VAL="https://${FIREBASE_PROJECT_ID}.web.app,https://${FIREBASE_PROJECT_ID}.firebaseapp.com"
          echo "CORS_ORIGINS: \"$CORS_VAL\"" > /tmp/cors-env.yml
          gcloud run services update video-image-api \
            --project $GCP_PROJECT_ID \
            --region europe-west1 \
            --env-vars-file /tmp/cors-env.yml \
            --quiet
